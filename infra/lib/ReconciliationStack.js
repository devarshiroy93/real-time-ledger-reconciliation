"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ReconciliationStack = void 0;
const cdk = require("aws-cdk-lib");
const dynamodb = require("aws-cdk-lib/aws-dynamodb");
const lambda = require("aws-cdk-lib/aws-lambda");
const path = require("path");
const apigateway = require("aws-cdk-lib/aws-apigateway");
const lambdaNodejs = require("aws-cdk-lib/aws-lambda-nodejs");
const sources = require("aws-cdk-lib/aws-lambda-event-sources");
class ReconciliationStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        // 1. Customer Ledger (simple: txId only)
        const customerLedger = new dynamodb.Table(this, "CustomerLedger", {
            partitionKey: { name: "txId", type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            stream: dynamodb.StreamViewType.NEW_AND_OLD_IMAGES,
            tableName: "ReconStack-CustomerLedger",
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        // 2. Processor Ledger (txId + timestamp, since multiple entries possible)
        const processorLedger = new dynamodb.Table(this, "ProcessorLedger", {
            partitionKey: { name: "txId", type: dynamodb.AttributeType.STRING },
            sortKey: { name: "timestamp", type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            stream: dynamodb.StreamViewType.NEW_AND_OLD_IMAGES,
            tableName: "ReconStack-ProcessorLedger",
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        // 3. Core Ledger (txId + timestamp, similar reasoning as processor)
        const coreLedger = new dynamodb.Table(this, "CoreLedger", {
            partitionKey: { name: "txId", type: dynamodb.AttributeType.STRING },
            sortKey: { name: "timestamp", type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            stream: dynamodb.StreamViewType.NEW_AND_OLD_IMAGES,
            tableName: "ReconStack-CoreLedger",
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        // 4. Reconciliation Findings (latest status only, one row per txId)
        const reconciliationFindings = new dynamodb.Table(this, "ReconciliationFindings", {
            partitionKey: { name: "txId", type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            tableName: "ReconStack-ReconciliationFindingsV2",
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        // 5. Daily Summary (date = PK)
        new dynamodb.Table(this, "DailySummary", {
            partitionKey: { name: "date", type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            tableName: "ReconStack-DailySummary",
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        // 6. Reconciliation Audit (full lifecycle, append-only)
        const reconciliationAudit = new dynamodb.Table(this, "ReconciliationAudit", {
            partitionKey: { name: "txId", type: dynamodb.AttributeType.STRING },
            sortKey: { name: "eventTimestamp", type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            tableName: "ReconStack-ReconciliationAudit",
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        // ---- Lambdas ----
        const submitTransactionLambda = new lambdaNodejs.NodejsFunction(this, "ReconStackSubmitTransactionLambda", {
            runtime: lambda.Runtime.NODEJS_18_X,
            entry: path.join(__dirname, "../../lambdas/submit-transaction/index.ts"),
            handler: "handler",
            environment: {
                CUSTOMER_LEDGER_TABLE: customerLedger.tableName,
            },
        });
        customerLedger.grantWriteData(submitTransactionLambda);
        const processorSimulatorLambda = new lambdaNodejs.NodejsFunction(this, "ReconStackProcessorSimulatorLambda", {
            runtime: lambda.Runtime.NODEJS_18_X,
            entry: path.join(__dirname, "../../lambdas/processor-simulator/index.ts"),
            handler: "handler",
            environment: {
                PROCESSOR_LEDGER_TABLE: processorLedger.tableName,
            },
        });
        processorLedger.grantWriteData(processorSimulatorLambda);
        const coreSimulatorLambda = new lambdaNodejs.NodejsFunction(this, "ReconStackCoreSimulatorLambda", {
            runtime: lambda.Runtime.NODEJS_18_X,
            entry: path.join(__dirname, "../../lambdas/core-simulator/index.ts"),
            handler: "handler",
            environment: {
                CORE_LEDGER_TABLE: coreLedger.tableName,
            },
        });
        coreLedger.grantWriteData(coreSimulatorLambda);
        const reconciliationFn = new lambdaNodejs.NodejsFunction(this, "ReconStackReconciliationEngineLambda", {
            runtime: lambda.Runtime.NODEJS_18_X,
            entry: path.join(__dirname, "../../lambdas/reconciliation-engine/index.ts"),
            handler: "handler",
            environment: {
                CUSTOMER_LEDGER_TABLE: customerLedger.tableName,
                PROCESSOR_LEDGER_TABLE: processorLedger.tableName,
                CORE_LEDGER_TABLE: coreLedger.tableName,
                FINDINGS_TABLE: reconciliationFindings.tableName,
                AUDIT_TABLE: reconciliationAudit.tableName,
            },
        });
        customerLedger.grantReadWriteData(reconciliationFn);
        processorLedger.grantReadData(reconciliationFn);
        coreLedger.grantReadData(reconciliationFn);
        reconciliationFindings.grantReadWriteData(reconciliationFn);
        reconciliationAudit.grantWriteData(reconciliationFn);
        reconciliationFn.addEventSource(new sources.DynamoEventSource(customerLedger, { startingPosition: lambda.StartingPosition.LATEST }));
        reconciliationFn.addEventSource(new sources.DynamoEventSource(processorLedger, { startingPosition: lambda.StartingPosition.LATEST }));
        reconciliationFn.addEventSource(new sources.DynamoEventSource(coreLedger, { startingPosition: lambda.StartingPosition.LATEST }));
        // ---- API Gateway ----
        const api = new apigateway.RestApi(this, "ReconciliationApi", {
            restApiName: "Reconciliation Service",
            description: "APIs for ledger reconciliation demo",
        });
        // API Key + Usage Plan
        const apiKey = api.addApiKey("ReconciliationApiKey", {
            apiKeyName: "ReconDemoKey",
            description: "API Key for Reconciliation POC",
        });
        const plan = api.addUsagePlan("ReconciliationUsagePlan", {
            name: "ReconUsagePlan",
            description: "Limit to 1 req/sec and 100 req/day",
            throttle: {
                rateLimit: 1,
                burstLimit: 1,
            },
            quota: {
                limit: 100,
                period: apigateway.Period.DAY,
            },
        });
        plan.addApiStage({ stage: api.deploymentStage });
        plan.addApiKey(apiKey);
        // Endpoints with API key required
        const transactionResource = api.root.addResource("transaction");
        transactionResource.addMethod("POST", new apigateway.LambdaIntegration(submitTransactionLambda), {
            apiKeyRequired: true,
        });
        const simulateResource = api.root.addResource("simulate");
        const processorResource = simulateResource.addResource("processor");
        processorResource.addMethod("POST", new apigateway.LambdaIntegration(processorSimulatorLambda), {
            apiKeyRequired: true,
        });
        const coreResource = simulateResource.addResource("core");
        coreResource.addMethod("POST", new apigateway.LambdaIntegration(coreSimulatorLambda), {
            apiKeyRequired: true,
        });
        //these are to support the UI .
        // GET /findings
        const getFindingsLambda = new lambdaNodejs.NodejsFunction(this, "ReconStackGetFindingsLambda", {
            runtime: lambda.Runtime.NODEJS_18_X,
            entry: path.join(__dirname, "../../lambdas/get-findings/index.ts"),
            handler: "handler",
            environment: {
                FINDINGS_TABLE: reconciliationFindings.tableName,
            },
        });
        reconciliationFindings.grantReadData(getFindingsLambda);
        const findingsResource = api.root.addResource("findings");
        findingsResource.addMethod("GET", new apigateway.LambdaIntegration(getFindingsLambda), {
            apiKeyRequired: true,
        });
        // GET /audit/{txId}
        const getAuditLambda = new lambdaNodejs.NodejsFunction(this, "ReconStackGetAuditLambda", {
            runtime: lambda.Runtime.NODEJS_18_X,
            entry: path.join(__dirname, "../../lambdas/get-audit/index.ts"),
            handler: "handler",
            environment: {
                AUDIT_TABLE: reconciliationAudit.tableName,
            },
        });
        reconciliationAudit.grantReadData(getAuditLambda);
        const auditResource = api.root.addResource("audit");
        const auditById = auditResource.addResource("{txId}");
        auditById.addMethod("GET", new apigateway.LambdaIntegration(getAuditLambda), {
            apiKeyRequired: true,
        });
    }
}
exports.ReconciliationStack = ReconciliationStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVjb25jaWxpYXRpb25TdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlJlY29uY2lsaWF0aW9uU3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsbUNBQW1DO0FBRW5DLHFEQUFxRDtBQUNyRCxpREFBaUQ7QUFDakQsNkJBQTZCO0FBQzdCLHlEQUF5RDtBQUN6RCw4REFBOEQ7QUFDOUQsZ0VBQWdFO0FBRWhFLE1BQWEsbUJBQW9CLFNBQVEsR0FBRyxDQUFDLEtBQUs7SUFDaEQsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFzQjtRQUM5RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4Qix5Q0FBeUM7UUFDekMsTUFBTSxjQUFjLEdBQUcsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxnQkFBZ0IsRUFBRTtZQUNoRSxZQUFZLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRTtZQUNuRSxXQUFXLEVBQUUsUUFBUSxDQUFDLFdBQVcsQ0FBQyxlQUFlO1lBQ2pELE1BQU0sRUFBRSxRQUFRLENBQUMsY0FBYyxDQUFDLGtCQUFrQjtZQUNsRCxTQUFTLEVBQUUsMkJBQTJCO1lBQ3RDLGFBQWEsRUFBRSxHQUFHLENBQUMsYUFBYSxDQUFDLE9BQU87U0FDekMsQ0FBQyxDQUFDO1FBRUgsMEVBQTBFO1FBQzFFLE1BQU0sZUFBZSxHQUFHLElBQUksUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsaUJBQWlCLEVBQUU7WUFDbEUsWUFBWSxFQUFFLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUU7WUFDbkUsT0FBTyxFQUFFLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLGFBQWEsQ0FBQyxN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QUFXLEVBQUU7Z0JBQ1gsV0FBVyxFQUFFLG1CQUFtQixDQUFDLFNBQVM7YUFDM0M7U0FDRixDQUFDLENBQUM7UUFDSCxtQkFBbUIsQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLENBQUM7UUFFbEQsTUFBTSxhQUFhLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDcEQsTUFBTSxTQUFTLEdBQUcsYUFBYSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN0RCxTQUFTLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxJQUFJLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxjQUFjLENBQUMsRUFBRTtZQUMzRSxjQUFjLEVBQUUsSUFBSTtTQUNyQixDQUFDLENBQUM7SUFFTCxDQUFDO0NBQ0Y7QUFyTUQsa0RBcU1DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2RrIGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCAqIGFzIGR5bmFtb2RiIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtZHluYW1vZGJcIjtcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWxhbWJkYVwiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgYXBpZ2F0ZXdheSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWFwaWdhdGV3YXlcIjtcbmltcG9ydCAqIGFzIGxhbWJkYU5vZGVqcyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWxhbWJkYS1ub2RlanNcIjtcbmltcG9ydCAqIGFzIHNvdXJjZXMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGEtZXZlbnQtc291cmNlc1wiO1xuXG5leHBvcnQgY2xhc3MgUmVjb25jaWxpYXRpb25TdGFjayBleHRlbmRzIGNkay5TdGFjayB7XG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogY2RrLlN0YWNrUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcblxuICAgIC8vIDEuIEN1c3RvbWVyIExlZGdlciAoc2ltcGxlOiB0eElkIG9ubHkpXG4gICAgY29uc3QgY3VzdG9tZXJMZWRnZXIgPSBuZXcgZHluYW1vZGIuVGFibGUodGhpcywgXCJDdXN0b21lckxlZGdlclwiLCB7XG4gICAgICBwYXJ0aXRpb25LZXk6IHsgbmFtZTogXCJ0eElkXCIsIHR5cGU6IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuU1RSSU5HIH0sXG4gICAgICBiaWxsaW5nTW9kZTogZHluYW1vZGIuQmlsbGluZ01vZGUuUEFZX1BFUl9SRVFVRVNULFxuICAgICAgc3RyZWFtOiBkeW5hbW9kYi5TdHJlYW1WaWV3VHlwZS5ORVdfQU5EX09MRF9JTUFHRVMsXG4gICAgICB0YWJsZU5hbWU6IFwiUmVjb25TdGFjay1DdXN0b21lckxlZGdlclwiLFxuICAgICAgcmVtb3ZhbFBvbGljeTogY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICB9KTtcblxuICAgIC8vIDIuIFByb2Nlc3NvciBMZWRnZXIgKHR4SWQgKyB0aW1lc3RhbXAsIHNpbmNlIG11bHRpcGxlIGVudHJpZXMgcG9zc2libGUpXG4gICAgY29uc3QgcHJvY2Vzc29yTGVkZ2VyID0gbmV3IGR5bmFtb2RiLlRhYmxlKHRoaXMsIFwiUHJvY2Vzc29yTGVkZ2VyXCIsIHtcbiAgICAgIHBhcnRpdGlvbktleTogeyBuYW1lOiBcInR4SWRcIiwgdHlwZTogZHluYW1vZGIuQXR0cmlidXRlVHlwZS5TVFJJTkcgfSxcbiAgICAgIHNvcnRLZXk6IHsgbmFtZTogXCJ0aW1lc3RhbXBcIiwgdHlwZTogZHluYW1vZGIuQXR0cmlidXRlVHlwZS5TVFJJTkcgfSxcbiAgICAgIGJpbGxpbmdNb2RlOiBkeW5hbW9kYi5CaWxsaW5nTW9kZS5QQVlfUEVSX1JFUVVFU1QsXG4gICAgICBzdHJlYW06IGR5bmFtb2RiLlN0cmVhbVZpZXdUeXBlLk5FV19BTkRfT0xEX0lNQUdFUyxcbiAgICAgIHRhYmxlTmFtZTogXCJSZWNvblN0YWNrLVByb2Nlc3NvckxlZGdlclwiLFxuICAgICAgcmVtb3ZhbFBvbGljeTogY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICB9KTtcblxuICAgIC8vIDMuIENvcmUgTGVkZ2VyICh0eElkICsgdGltZXN0YW1wLCBzaW1pbGFyIHJlYXNvbmluZyBhcyBwcm9jZXNzb3IpXG4gICAgY29uc3QgY29yZUxlZGdlciA9IG5ldyBkeW5hbW9kYi5UYWJsZSh0aGlzLCBcIkNvcmVMZWRnZXJcIiwge1xuICAgICAgcGFydGl0aW9uS2V5OiB7IG5hbWU6IFwidHhJZFwiLCB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyB9LFxuICAgICAgc29ydEtleTogeyBuYW1lOiBcInRpbWVzdGFtcFwiLCB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyB9LFxuICAgICAgYmlsbGluZ01vZGU6IGR5bmFtb2RiLkJpbGxpbmdNb2RlLlBBWV9QRVJfUkVRVUVTVCxcbiAgICAgIHN0cmVhbTogZHluYW1vZGIuU3RyZWFtVmlld1R5cGUuTkVXX0FORF9PTERfSU1BR0VTLFxuICAgICAgdGFibGVOYW1lOiBcIlJlY29uU3RhY2stQ29yZUxlZGdlclwiLFxuICAgICAgcmVtb3ZhbFBvbGljeTogY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICB9KTtcblxuICAgIC8vIDQuIFJlY29uY2lsaWF0aW9uIEZpbmRpbmdzIChsYXRlc3Qgc3RhdHVzIG9ubHksIG9uZSByb3cgcGVyIHR4SWQpXG4gICAgY29uc3QgcmVjb25jaWxpYXRpb25GaW5kaW5ncyA9IG5ldyBkeW5hbW9kYi5UYWJsZSh0aGlzLCBcIlJlY29uY2lsaWF0aW9uRmluZGluZ3NcIiwge1xuICAgICAgcGFydGl0aW9uS2V5OiB7IG5hbWU6IFwidHhJZFwiLCB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyB9LFxuICAgICAgYmlsbGluZ01vZGU6IGR5bmFtb2RiLkJpbGxpbmdNb2RlLlBBWV9QRVJfUkVRVUVTVCxcbiAgICAgIHRhYmxlTmFtZTogXCJSZWNvblN0YWNrLVJlY29uY2lsaWF0aW9uRmluZGluZ3NWMlwiLFxuICAgICAgcmVtb3ZhbFBvbGljeTogY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICB9KTtcblxuICAgIC8vIDUuIERhaWx5IFN1bW1hcnkgKGRhdGUgPSBQSylcbiAgICBuZXcgZHluYW1vZGIuVGFibGUodGhpcywgXCJEYWlseVN1bW1hcnlcIiwge1xuICAgICAgcGFydGl0aW9uS2V5OiB7IG5hbWU6IFwiZGF0ZVwiLCB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyB9LFxuICAgICAgYmlsbGluZ01vZGU6IGR5bmFtb2RiLkJpbGxpbmdNb2RlLlBBWV9QRVJfUkVRVUVTVCxcbiAgICAgIHRhYmxlTmFtZTogXCJSZWNvblN0YWNrLURhaWx5U3VtbWFyeVwiLFxuICAgICAgcmVtb3ZhbFBvbGljeTogY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICB9KTtcblxuICAgIC8vIDYuIFJlY29uY2lsaWF0aW9uIEF1ZGl0IChmdWxsIGxpZmVjeWNsZSwgYXBwZW5kLW9ubHkpXG4gICAgY29uc3QgcmVjb25jaWxpYXRpb25BdWRpdCA9IG5ldyBkeW5hbW9kYi5UYWJsZSh0aGlzLCBcIlJlY29uY2lsaWF0aW9uQXVkaXRcIiwge1xuICAgICAgcGFydGl0aW9uS2V5OiB7IG5hbWU6IFwidHhJZFwiLCB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyB9LFxuICAgICAgc29ydEtleTogeyBuYW1lOiBcImV2ZW50VGltZXN0YW1wXCIsIHR5cGU6IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuU1RSSU5HIH0sXG4gICAgICBiaWxsaW5nTW9kZTogZHluYW1vZGIuQmlsbGluZ01vZGUuUEFZX1BFUl9SRVFVRVNULFxuICAgICAgdGFibGVOYW1lOiBcIlJlY29uU3RhY2stUmVjb25jaWxpYXRpb25BdWRpdFwiLFxuICAgICAgcmVtb3ZhbFBvbGljeTogY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICB9KTtcblxuICAgIC8vIC0tLS0gTGFtYmRhcyAtLS0tXG4gICAgY29uc3Qgc3VibWl0VHJhbnNhY3Rpb25MYW1iZGEgPSBuZXcgbGFtYmRhTm9kZWpzLk5vZGVqc0Z1bmN0aW9uKHRoaXMsIFwiUmVjb25TdGFja1N1Ym1pdFRyYW5zYWN0aW9uTGFtYmRhXCIsIHtcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xOF9YLFxuICAgICAgZW50cnk6IHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vLi4vbGFtYmRhcy9zdWJtaXQtdHJhbnNhY3Rpb24vaW5kZXgudHNcIiksXG4gICAgICBoYW5kbGVyOiBcImhhbmRsZXJcIixcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIENVU1RPTUVSX0xFREdFUl9UQUJMRTogY3VzdG9tZXJMZWRnZXIudGFibGVOYW1lLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICBjdXN0b21lckxlZGdlci5ncmFudFdyaXRlRGF0YShzdWJtaXRUcmFuc2FjdGlvbkxhbWJkYSk7XG5cbiAgICBjb25zdCBwcm9jZXNzb3JTaW11bGF0b3JMYW1iZGEgPSBuZXcgbGFtYmRhTm9kZWpzLk5vZGVqc0Z1bmN0aW9uKHRoaXMsIFwiUmVjb25TdGFja1Byb2Nlc3NvclNpbXVsYXRvckxhbWJkYVwiLCB7XG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMThfWCxcbiAgICAgIGVudHJ5OiBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uLy4uL2xhbWJkYXMvcHJvY2Vzc29yLXNpbXVsYXRvci9pbmRleC50c1wiKSxcbiAgICAgIGhhbmRsZXI6IFwiaGFuZGxlclwiLFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgUFJPQ0VTU09SX0xFREdFUl9UQUJMRTogcHJvY2Vzc29yTGVkZ2VyLnRhYmxlTmFtZSxcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgcHJvY2Vzc29yTGVkZ2VyLmdyYW50V3JpdGVEYXRhKHByb2Nlc3NvclNpbXVsYXRvckxhbWJkYSk7XG5cbiAgICBjb25zdCBjb3JlU2ltdWxhdG9yTGFtYmRhID0gbmV3IGxhbWJkYU5vZGVqcy5Ob2RlanNGdW5jdGlvbih0aGlzLCBcIlJlY29uU3RhY2tDb3JlU2ltdWxhdG9yTGFtYmRhXCIsIHtcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xOF9YLFxuICAgICAgZW50cnk6IHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vLi4vbGFtYmRhcy9jb3JlLXNpbXVsYXRvci9pbmRleC50c1wiKSxcbiAgICAgIGhhbmRsZXI6IFwiaGFuZGxlclwiLFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgQ09SRV9MRURHRVJfVEFCTEU6IGNvcmVMZWRnZXIudGFibGVOYW1lLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICBjb3JlTGVkZ2VyLmdyYW50V3JpdGVEYXRhKGNvcmVTaW11bGF0b3JMYW1iZGEpO1xuXG4gICAgY29uc3QgcmVjb25jaWxpYXRpb25GbiA9IG5ldyBsYW1iZGFOb2RlanMuTm9kZWpzRnVuY3Rpb24odGhpcywgXCJSZWNvblN0YWNrUmVjb25jaWxpYXRpb25FbmdpbmVMYW1iZGFcIiwge1xuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE4X1gsXG4gICAgICBlbnRyeTogcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLi8uLi9sYW1iZGFzL3JlY29uY2lsaWF0aW9uLWVuZ2luZS9pbmRleC50c1wiKSxcbiAgICAgIGhhbmRsZXI6IFwiaGFuZGxlclwiLFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgQ1VTVE9NRVJfTEVER0VSX1RBQkxFOiBjdXN0b21lckxlZGdlci50YWJsZU5hbWUsXG4gICAgICAgIFBST0NFU1NPUl9MRURHRVJfVEFCTEU6IHByb2Nlc3NvckxlZGdlci50YWJsZU5hbWUsXG4gICAgICAgIENPUkVfTEVER0VSX1RBQkxFOiBjb3JlTGVkZ2VyLnRhYmxlTmFtZSxcbiAgICAgICAgRklORElOR1NfVEFCTEU6IHJlY29uY2lsaWF0aW9uRmluZGluZ3MudGFibGVOYW1lLFxuICAgICAgICBBVURJVF9UQUJMRTogcmVjb25jaWxpYXRpb25BdWRpdC50YWJsZU5hbWUsXG4gICAgICB9LFxuICAgIH0pO1xuICAgIGN1c3RvbWVyTGVkZ2VyLmdyYW50UmVhZFdyaXRlRGF0YShyZWNvbmNpbGlhdGlvbkZuKTtcbiAgICBwcm9jZXNzb3JMZWRnZXIuZ3JhbnRSZWFkRGF0YShyZWNvbmNpbGlhdGlvbkZuKTtcbiAgICBjb3JlTGVkZ2VyLmdyYW50UmVhZERhdGEocmVjb25jaWxpYXRpb25Gbik7XG4gICAgcmVjb25jaWxpYXRpb25GaW5kaW5ncy5ncmFudFJlYWRXcml0ZURhdGEocmVjb25jaWxpYXRpb25Gbik7XG4gICAgcmVjb25jaWxpYXRpb25BdWRpdC5ncmFudFdyaXRlRGF0YShyZWNvbmNpbGlhdGlvbkZuKTtcblxuICAgIHJlY29uY2lsaWF0aW9uRm4uYWRkRXZlbnRTb3VyY2UoXG4gICAgICBuZXcgc291cmNlcy5EeW5hbW9FdmVudFNvdXJjZShjdXN0b21lckxlZGdlciwgeyBzdGFydGluZ1Bvc2l0aW9uOiBsYW1iZGEuU3RhcnRpbmdQb3NpdGlvbi5MQVRFU1QgfSlcbiAgICApO1xuICAgIHJlY29uY2lsaWF0aW9uRm4uYWRkRXZlbnRTb3VyY2UoXG4gICAgICBuZXcgc291cmNlcy5EeW5hbW9FdmVudFNvdXJjZShwcm9jZXNzb3JMZWRnZXIsIHsgc3RhcnRpbmdQb3NpdGlvbjogbGFtYmRhLlN0YXJ0aW5nUG9zaXRpb24uTEFURVNUIH0pXG4gICAgKTtcbiAgICByZWNvbmNpbGlhdGlvbkZuLmFkZEV2ZW50U291cmNlKFxuICAgICAgbmV3IHNvdXJjZXMuRHluYW1vRXZlbnRTb3VyY2UoY29yZUxlZGdlciwgeyBzdGFydGluZ1Bvc2l0aW9uOiBsYW1iZGEuU3RhcnRpbmdQb3NpdGlvbi5MQVRFU1QgfSlcbiAgICApO1xuXG4gICAgLy8gLS0tLSBBUEkgR2F0ZXdheSAtLS0tXG4gICAgY29uc3QgYXBpID0gbmV3IGFwaWdhdGV3YXkuUmVzdEFwaSh0aGlzLCBcIlJlY29uY2lsaWF0aW9uQXBpXCIsIHtcbiAgICAgIHJlc3RBcGlOYW1lOiBcIlJlY29uY2lsaWF0aW9uIFNlcnZpY2VcIixcbiAgICAgIGRlc2NyaXB0aW9uOiBcIkFQSXMgZm9yIGxlZGdlciByZWNvbmNpbGlhdGlvbiBkZW1vXCIsXG4gICAgfSk7XG5cbiAgICAvLyBBUEkgS2V5ICsgVXNhZ2UgUGxhblxuICAgIGNvbnN0IGFwaUtleSA9IGFwaS5hZGRBcGlLZXkoXCJSZWNvbmNpbGlhdGlvbkFwaUtleVwiLCB7XG4gICAgICBhcGlLZXlOYW1lOiBcIlJlY29uRGVtb0tleVwiLFxuICAgICAgZGVzY3JpcHRpb246IFwiQVBJIEtleSBmb3IgUmVjb25jaWxpYXRpb24gUE9DXCIsXG4gICAgfSk7XG5cbiAgICBjb25zdCBwbGFuID0gYXBpLmFkZFVzYWdlUGxhbihcIlJlY29uY2lsaWF0aW9uVXNhZ2VQbGFuXCIsIHtcbiAgICAgIG5hbWU6IFwiUmVjb25Vc2FnZVBsYW5cIixcbiAgICAgIGRlc2NyaXB0aW9uOiBcIkxpbWl0IHRvIDEgcmVxL3NlYyBhbmQgMTAwIHJlcS9kYXlcIixcbiAgICAgIHRocm90dGxlOiB7XG4gICAgICAgIHJhdGVMaW1pdDogMSxcbiAgICAgICAgYnVyc3RMaW1pdDogMSxcbiAgICAgIH0sXG4gICAgICBxdW90YToge1xuICAgICAgICBsaW1pdDogMTAwLFxuICAgICAgICBwZXJpb2Q6IGFwaWdhdGV3YXkuUGVyaW9kLkRBWSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBwbGFuLmFkZEFwaVN0YWdlKHsgc3RhZ2U6IGFwaS5kZXBsb3ltZW50U3RhZ2UgfSk7XG4gICAgcGxhbi5hZGRBcGlLZXkoYXBpS2V5KTtcblxuICAgIC8vIEVuZHBvaW50cyB3aXRoIEFQSSBrZXkgcmVxdWlyZWRcbiAgICBjb25zdCB0cmFuc2FjdGlvblJlc291cmNlID0gYXBpLnJvb3QuYWRkUmVzb3VyY2UoXCJ0cmFuc2FjdGlvblwiKTtcbiAgICB0cmFuc2FjdGlvblJlc291cmNlLmFkZE1ldGhvZChcIlBPU1RcIiwgbmV3IGFwaWdhdGV3YXkuTGFtYmRhSW50ZWdyYXRpb24oc3VibWl0VHJhbnNhY3Rpb25MYW1iZGEpLCB7XG4gICAgICBhcGlLZXlSZXF1aXJlZDogdHJ1ZSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHNpbXVsYXRlUmVzb3VyY2UgPSBhcGkucm9vdC5hZGRSZXNvdXJjZShcInNpbXVsYXRlXCIpO1xuICAgIGNvbnN0IHByb2Nlc3NvclJlc291cmNlID0gc2ltdWxhdGVSZXNvdXJjZS5hZGRSZXNvdXJjZShcInByb2Nlc3NvclwiKTtcbiAgICBwcm9jZXNzb3JSZXNvdXJjZS5hZGRNZXRob2QoXCJQT1NUXCIsIG5ldyBhcGlnYXRld2F5LkxhbWJkYUludGVncmF0aW9uKHByb2Nlc3NvclNpbXVsYXRvckxhbWJkYSksIHtcbiAgICAgIGFwaUtleVJlcXVpcmVkOiB0cnVlLFxuICAgIH0pO1xuXG4gICAgY29uc3QgY29yZVJlc291cmNlID0gc2ltdWxhdGVSZXNvdXJjZS5hZGRSZXNvdXJjZShcImNvcmVcIik7XG4gICAgY29yZVJlc291cmNlLmFkZE1ldGhvZChcIlBPU1RcIiwgbmV3IGFwaWdhdGV3YXkuTGFtYmRhSW50ZWdyYXRpb24oY29yZVNpbXVsYXRvckxhbWJkYSksIHtcbiAgICAgIGFwaUtleVJlcXVpcmVkOiB0cnVlLFxuICAgIH0pO1xuXG4gICAgLy90aGVzZSBhcmUgdG8gc3VwcG9ydCB0aGUgVUkgLlxuICAgIC8vIEdFVCAvZmluZGluZ3NcbiAgICBjb25zdCBnZXRGaW5kaW5nc0xhbWJkYSA9IG5ldyBsYW1iZGFOb2RlanMuTm9kZWpzRnVuY3Rpb24odGhpcywgXCJSZWNvblN0YWNrR2V0RmluZGluZ3NMYW1iZGFcIiwge1xuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE4X1gsXG4gICAgICBlbnRyeTogcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLi8uLi9sYW1iZGFzL2dldC1maW5kaW5ncy9pbmRleC50c1wiKSxcbiAgICAgIGhhbmRsZXI6IFwiaGFuZGxlclwiLFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgRklORElOR1NfVEFCTEU6IHJlY29uY2lsaWF0aW9uRmluZGluZ3MudGFibGVOYW1lLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICByZWNvbmNpbGlhdGlvbkZpbmRpbmdzLmdyYW50UmVhZERhdGEoZ2V0RmluZGluZ3NMYW1iZGEpO1xuXG4gICAgY29uc3QgZmluZGluZ3NSZXNvdXJjZSA9IGFwaS5yb290LmFkZFJlc291cmNlKFwiZmluZGluZ3NcIik7XG4gICAgZmluZGluZ3NSZXNvdXJjZS5hZGRNZXRob2QoXCJHRVRcIiwgbmV3IGFwaWdhdGV3YXkuTGFtYmRhSW50ZWdyYXRpb24oZ2V0RmluZGluZ3NMYW1iZGEpLCB7XG4gICAgICBhcGlLZXlSZXF1aXJlZDogdHJ1ZSxcbiAgICB9KTtcblxuICAgIC8vIEdFVCAvYXVkaXQve3R4SWR9XG4gICAgY29uc3QgZ2V0QXVkaXRMYW1iZGEgPSBuZXcgbGFtYmRhTm9kZWpzLk5vZGVqc0Z1bmN0aW9uKHRoaXMsIFwiUmVjb25TdGFja0dldEF1ZGl0TGFtYmRhXCIsIHtcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xOF9YLFxuICAgICAgZW50cnk6IHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vLi4vbGFtYmRhcy9nZXQtYXVkaXQvaW5kZXgudHNcIiksXG4gICAgICBoYW5kbGVyOiBcImhhbmRsZXJcIixcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIEFVRElUX1RBQkxFOiByZWNvbmNpbGlhdGlvbkF1ZGl0LnRhYmxlTmFtZSxcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgcmVjb25jaWxpYXRpb25BdWRpdC5ncmFudFJlYWREYXRhKGdldEF1ZGl0TGFtYmRhKTtcblxuICAgIGNvbnN0IGF1ZGl0UmVzb3VyY2UgPSBhcGkucm9vdC5hZGRSZXNvdXJjZShcImF1ZGl0XCIpO1xuICAgIGNvbnN0IGF1ZGl0QnlJZCA9IGF1ZGl0UmVzb3VyY2UuYWRkUmVzb3VyY2UoXCJ7dHhJZH1cIik7XG4gICAgYXVkaXRCeUlkLmFkZE1ldGhvZChcIkdFVFwiLCBuZXcgYXBpZ2F0ZXdheS5MYW1iZGFJbnRlZ3JhdGlvbihnZXRBdWRpdExhbWJkYSksIHtcbiAgICAgIGFwaUtleVJlcXVpcmVkOiB0cnVlLFxuICAgIH0pO1xuXG4gIH1cbn1cbiJdfQ==