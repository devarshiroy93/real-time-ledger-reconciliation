"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ReconciliationStack = void 0;
const cdk = require("aws-cdk-lib");
const dynamodb = require("aws-cdk-lib/aws-dynamodb");
const lambda = require("aws-cdk-lib/aws-lambda");
const path = require("path");
const apigateway = require("aws-cdk-lib/aws-apigateway");
const lambdaNodejs = require("aws-cdk-lib/aws-lambda-nodejs");
const sources = require("aws-cdk-lib/aws-lambda-event-sources");
class ReconciliationStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        // 1. Customer Ledger (simple: txId only)
        const customerLedger = new dynamodb.Table(this, "CustomerLedger", {
            partitionKey: { name: "txId", type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            stream: dynamodb.StreamViewType.NEW_AND_OLD_IMAGES,
            tableName: "ReconStack-CustomerLedger",
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        // 2. Processor Ledger (txId + timestamp, since multiple entries possible)
        const processorLedger = new dynamodb.Table(this, "ProcessorLedger", {
            partitionKey: { name: "txId", type: dynamodb.AttributeType.STRING },
            sortKey: { name: "timestamp", type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            stream: dynamodb.StreamViewType.NEW_AND_OLD_IMAGES,
            tableName: "ReconStack-ProcessorLedger",
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        // 3. Core Ledger (txId + timestamp, similar reasoning as processor)
        const coreLedger = new dynamodb.Table(this, "CoreLedger", {
            partitionKey: { name: "txId", type: dynamodb.AttributeType.STRING },
            sortKey: { name: "timestamp", type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            stream: dynamodb.StreamViewType.NEW_AND_OLD_IMAGES,
            tableName: "ReconStack-CoreLedger",
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        // 4. Reconciliation Findings (latest status only, one row per txId)
        const reconciliationFindings = new dynamodb.Table(this, "ReconciliationFindings", {
            partitionKey: { name: "txId", type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            tableName: "ReconStack-ReconciliationFindings",
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        // 5. Daily Summary (date = PK)
        new dynamodb.Table(this, "DailySummary", {
            partitionKey: { name: "date", type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            tableName: "ReconStack-DailySummary",
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        // 6. Reconciliation Audit (full lifecycle, append-only)
        const reconciliationAudit = new dynamodb.Table(this, "ReconciliationAudit", {
            partitionKey: { name: "txId", type: dynamodb.AttributeType.STRING },
            sortKey: { name: "eventTimestamp", type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            tableName: "ReconStack-ReconciliationAudit",
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        const submitTransactionLambda = new lambdaNodejs.NodejsFunction(this, "ReconStackSubmitTransactionLambda", {
            runtime: lambda.Runtime.NODEJS_18_X,
            entry: path.join(__dirname, "../../lambdas/submit-transaction/index.ts"), // ðŸ‘ˆ point to .ts file
            handler: "handler", // ðŸ‘ˆ name of the exported function in index.ts
            environment: {
                CUSTOMER_LEDGER_TABLE: customerLedger.tableName,
            },
        });
        // Grant write access
        customerLedger.grantWriteData(submitTransactionLambda);
        // ðŸš€ API Gateway
        const api = new apigateway.RestApi(this, "ReconciliationApi", {
            restApiName: "Reconciliation Service",
            description: "APIs for ledger reconciliation demo",
        });
        // POST /transaction â†’ SubmitTransaction Lambda
        const transactionResource = api.root.addResource("transaction");
        transactionResource.addMethod("POST", new apigateway.LambdaIntegration(submitTransactionLambda));
        // ProcessorSimulator Lambda
        const processorSimulatorLambda = new lambdaNodejs.NodejsFunction(this, "ReconStackProcessorSimulatorLambda", {
            runtime: lambda.Runtime.NODEJS_18_X,
            entry: path.join(__dirname, "../../lambdas/processor-simulator/index.ts"),
            handler: "handler",
            environment: {
                PROCESSOR_LEDGER_TABLE: processorLedger.tableName,
            },
        });
        // Grant write access
        processorLedger.grantWriteData(processorSimulatorLambda);
        // API Gateway â€“ add /simulate/processor
        const simulateResource = api.root.addResource("simulate");
        const processorResource = simulateResource.addResource("processor");
        processorResource.addMethod("POST", new apigateway.LambdaIntegration(processorSimulatorLambda));
        // CoreSimulator Lambda
        const coreSimulatorLambda = new lambdaNodejs.NodejsFunction(this, "ReconStackCoreSimulatorLambda", {
            runtime: lambda.Runtime.NODEJS_18_X,
            entry: path.join(__dirname, "../../lambdas/core-simulator/index.ts"),
            handler: "handler",
            environment: {
                CORE_LEDGER_TABLE: coreLedger.tableName,
            },
        });
        // Grant write access
        coreLedger.grantWriteData(coreSimulatorLambda);
        // API Gateway â€“ add /simulate/core
        const coreResource = simulateResource.addResource("core");
        coreResource.addMethod("POST", new apigateway.LambdaIntegration(coreSimulatorLambda));
        // ReconciliationEngine Lambda
        const reconciliationFn = new lambdaNodejs.NodejsFunction(this, "ReconStackReconciliationEngineLambda", {
            runtime: lambda.Runtime.NODEJS_18_X,
            entry: path.join(__dirname, "../../lambdas/reconciliation-engine/index.ts"),
            handler: "handler",
            environment: {
                CUSTOMER_LEDGER_TABLE: customerLedger.tableName,
                PROCESSOR_LEDGER_TABLE: processorLedger.tableName,
                CORE_LEDGER_TABLE: coreLedger.tableName,
                FINDINGS_TABLE: reconciliationFindings.tableName,
                AUDIT_TABLE: reconciliationAudit.tableName,
            },
        });
        // Permissions
        customerLedger.grantReadWriteData(reconciliationFn);
        processorLedger.grantReadData(reconciliationFn);
        coreLedger.grantReadData(reconciliationFn);
        reconciliationFindings.grantReadWriteData(reconciliationFn);
        reconciliationAudit.grantWriteData(reconciliationFn);
        // Attach streams
        reconciliationFn.addEventSource(new sources.DynamoEventSource(customerLedger, { startingPosition: lambda.StartingPosition.LATEST }));
        reconciliationFn.addEventSource(new sources.DynamoEventSource(processorLedger, { startingPosition: lambda.StartingPosition.LATEST }));
        reconciliationFn.addEventSource(new sources.DynamoEventSource(coreLedger, { startingPosition: lambda.StartingPosition.LATEST }));
    }
}
exports.ReconciliationStack = ReconciliationStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVjb25jaWxpYXRpb25TdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlJlY29uY2lsaWF0aW9uU3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsbUNBQW1DO0FBRW5DLHFEQUFxRDtBQUNyRCxpREFBaUQ7QUFDakQsNkJBQTZCO0FBQzdCLHlEQUF5RDtBQUN6RCw4REFBOEQ7QUFDOUQsZ0VBQWdFO0FBRWhFLE1BQWEsbUJBQW9CLFNBQVEsR0FBRyxDQUFDLEtBQUs7SUFDaEQsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFzQjtRQUM5RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4Qix5Q0FBeUM7UUFDekMsTUFBTSxjQUFjLEdBQUcsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxnQkFBZ0IsRUFBRTtZQUNoRSxZQUFZLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRTtZQUNuRSxXQUFXLEVBQUUsUUFBUSxDQUFDLFdBQVcsQ0FBQyxlQUFlO1lBQ2pELE1BQU0sRUFBRSxRQUFRLENBQUMsY0FBYyxDQUFDLGtCQUFrQjtZQUNsRCxTQUFTLEVBQUUsMkJBQTJCO1lBQ3RDLGFBQWEsRUFBRSxHQUFHLENBQUMsYUFBYSxDQUFDLE9BQU87U0FDekMsQ0FBQyxDQUFDO1FBRUgsMEVBQTBFO1FBQzFFLE1BQU0sZUFBZSxHQUFHLElBQUksUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsaUJBQWlCLEVBQUU7WUFDbEUsWUFBWSxFQUFFLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUU7WUFDbkUsT0FBTyxFQUFFLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLGFBQWEsQ0FBQyxN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QUFjO1FBQ2QsY0FBYyxDQUFDLGtCQUFrQixDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDcEQsZUFBZSxDQUFDLGFBQWEsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ2hELFVBQVUsQ0FBQyxhQUFhLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUMzQyxzQkFBc0IsQ0FBQyxrQkFBa0IsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzVELG1CQUFtQixDQUFDLGNBQWMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBRXJELGlCQUFpQjtRQUNqQixnQkFBZ0IsQ0FBQyxjQUFjLENBQUMsSUFBSSxPQUFPLENBQUMsaUJBQWlCLENBQUMsY0FBYyxFQUFFLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNySSxnQkFBZ0IsQ0FBQyxjQUFjLENBQUMsSUFBSSxPQUFPLENBQUMsaUJBQWlCLENBQUMsZUFBZSxFQUFFLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN0SSxnQkFBZ0IsQ0FBQyxjQUFjLENBQUMsSUFBSSxPQUFPLENBQUMsaUJBQWlCLENBQUMsVUFBVSxFQUFFLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNuSSxDQUFDO0NBR0Y7QUFwS0Qsa0RBb0tDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2RrIGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCAqIGFzIGR5bmFtb2RiIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtZHluYW1vZGJcIjtcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWxhbWJkYVwiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgYXBpZ2F0ZXdheSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWFwaWdhdGV3YXlcIjtcbmltcG9ydCAqIGFzIGxhbWJkYU5vZGVqcyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWxhbWJkYS1ub2RlanNcIjtcbmltcG9ydCAqIGFzIHNvdXJjZXMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGEtZXZlbnQtc291cmNlc1wiO1xuXG5leHBvcnQgY2xhc3MgUmVjb25jaWxpYXRpb25TdGFjayBleHRlbmRzIGNkay5TdGFjayB7XG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogY2RrLlN0YWNrUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcblxuICAgIC8vIDEuIEN1c3RvbWVyIExlZGdlciAoc2ltcGxlOiB0eElkIG9ubHkpXG4gICAgY29uc3QgY3VzdG9tZXJMZWRnZXIgPSBuZXcgZHluYW1vZGIuVGFibGUodGhpcywgXCJDdXN0b21lckxlZGdlclwiLCB7XG4gICAgICBwYXJ0aXRpb25LZXk6IHsgbmFtZTogXCJ0eElkXCIsIHR5cGU6IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuU1RSSU5HIH0sXG4gICAgICBiaWxsaW5nTW9kZTogZHluYW1vZGIuQmlsbGluZ01vZGUuUEFZX1BFUl9SRVFVRVNULFxuICAgICAgc3RyZWFtOiBkeW5hbW9kYi5TdHJlYW1WaWV3VHlwZS5ORVdfQU5EX09MRF9JTUFHRVMsXG4gICAgICB0YWJsZU5hbWU6IFwiUmVjb25TdGFjay1DdXN0b21lckxlZGdlclwiLFxuICAgICAgcmVtb3ZhbFBvbGljeTogY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICB9KTtcblxuICAgIC8vIDIuIFByb2Nlc3NvciBMZWRnZXIgKHR4SWQgKyB0aW1lc3RhbXAsIHNpbmNlIG11bHRpcGxlIGVudHJpZXMgcG9zc2libGUpXG4gICAgY29uc3QgcHJvY2Vzc29yTGVkZ2VyID0gbmV3IGR5bmFtb2RiLlRhYmxlKHRoaXMsIFwiUHJvY2Vzc29yTGVkZ2VyXCIsIHtcbiAgICAgIHBhcnRpdGlvbktleTogeyBuYW1lOiBcInR4SWRcIiwgdHlwZTogZHluYW1vZGIuQXR0cmlidXRlVHlwZS5TVFJJTkcgfSxcbiAgICAgIHNvcnRLZXk6IHsgbmFtZTogXCJ0aW1lc3RhbXBcIiwgdHlwZTogZHluYW1vZGIuQXR0cmlidXRlVHlwZS5TVFJJTkcgfSxcbiAgICAgIGJpbGxpbmdNb2RlOiBkeW5hbW9kYi5CaWxsaW5nTW9kZS5QQVlfUEVSX1JFUVVFU1QsXG4gICAgICBzdHJlYW06IGR5bmFtb2RiLlN0cmVhbVZpZXdUeXBlLk5FV19BTkRfT0xEX0lNQUdFUyxcbiAgICAgIHRhYmxlTmFtZTogXCJSZWNvblN0YWNrLVByb2Nlc3NvckxlZGdlclwiLFxuICAgICAgcmVtb3ZhbFBvbGljeTogY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICB9KTtcblxuICAgIC8vIDMuIENvcmUgTGVkZ2VyICh0eElkICsgdGltZXN0YW1wLCBzaW1pbGFyIHJlYXNvbmluZyBhcyBwcm9jZXNzb3IpXG4gICAgY29uc3QgY29yZUxlZGdlciA9IG5ldyBkeW5hbW9kYi5UYWJsZSh0aGlzLCBcIkNvcmVMZWRnZXJcIiwge1xuICAgICAgcGFydGl0aW9uS2V5OiB7IG5hbWU6IFwidHhJZFwiLCB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyB9LFxuICAgICAgc29ydEtleTogeyBuYW1lOiBcInRpbWVzdGFtcFwiLCB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyB9LFxuICAgICAgYmlsbGluZ01vZGU6IGR5bmFtb2RiLkJpbGxpbmdNb2RlLlBBWV9QRVJfUkVRVUVTVCxcbiAgICAgIHN0cmVhbTogZHluYW1vZGIuU3RyZWFtVmlld1R5cGUuTkVXX0FORF9PTERfSU1BR0VTLFxuICAgICAgdGFibGVOYW1lOiBcIlJlY29uU3RhY2stQ29yZUxlZGdlclwiLFxuICAgICAgcmVtb3ZhbFBvbGljeTogY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICB9KTtcblxuICAgIC8vIDQuIFJlY29uY2lsaWF0aW9uIEZpbmRpbmdzIChsYXRlc3Qgc3RhdHVzIG9ubHksIG9uZSByb3cgcGVyIHR4SWQpXG4gICAgY29uc3QgcmVjb25jaWxpYXRpb25GaW5kaW5ncyA9IG5ldyBkeW5hbW9kYi5UYWJsZSh0aGlzLCBcIlJlY29uY2lsaWF0aW9uRmluZGluZ3NcIiwge1xuICAgICAgcGFydGl0aW9uS2V5OiB7IG5hbWU6IFwidHhJZFwiLCB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyB9LFxuICAgICAgYmlsbGluZ01vZGU6IGR5bmFtb2RiLkJpbGxpbmdNb2RlLlBBWV9QRVJfUkVRVUVTVCxcbiAgICAgIHRhYmxlTmFtZTogXCJSZWNvblN0YWNrLVJlY29uY2lsaWF0aW9uRmluZGluZ3NcIixcbiAgICAgIHJlbW92YWxQb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgfSk7XG5cbiAgICAvLyA1LiBEYWlseSBTdW1tYXJ5IChkYXRlID0gUEspXG4gICAgbmV3IGR5bmFtb2RiLlRhYmxlKHRoaXMsIFwiRGFpbHlTdW1tYXJ5XCIsIHtcbiAgICAgIHBhcnRpdGlvbktleTogeyBuYW1lOiBcImRhdGVcIiwgdHlwZTogZHluYW1vZGIuQXR0cmlidXRlVHlwZS5TVFJJTkcgfSxcbiAgICAgIGJpbGxpbmdNb2RlOiBkeW5hbW9kYi5CaWxsaW5nTW9kZS5QQVlfUEVSX1JFUVVFU1QsXG4gICAgICB0YWJsZU5hbWU6IFwiUmVjb25TdGFjay1EYWlseVN1bW1hcnlcIixcbiAgICAgIHJlbW92YWxQb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgfSk7XG5cbiAgICAvLyA2LiBSZWNvbmNpbGlhdGlvbiBBdWRpdCAoZnVsbCBsaWZlY3ljbGUsIGFwcGVuZC1vbmx5KVxuICAgIGNvbnN0IHJlY29uY2lsaWF0aW9uQXVkaXQgPSBuZXcgZHluYW1vZGIuVGFibGUodGhpcywgXCJSZWNvbmNpbGlhdGlvbkF1ZGl0XCIsIHtcbiAgICAgIHBhcnRpdGlvbktleTogeyBuYW1lOiBcInR4SWRcIiwgdHlwZTogZHluYW1vZGIuQXR0cmlidXRlVHlwZS5TVFJJTkcgfSxcbiAgICAgIHNvcnRLZXk6IHsgbmFtZTogXCJldmVudFRpbWVzdGFtcFwiLCB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklORyB9LFxuICAgICAgYmlsbGluZ01vZGU6IGR5bmFtb2RiLkJpbGxpbmdNb2RlLlBBWV9QRVJfUkVRVUVTVCxcbiAgICAgIHRhYmxlTmFtZTogXCJSZWNvblN0YWNrLVJlY29uY2lsaWF0aW9uQXVkaXRcIixcbiAgICAgIHJlbW92YWxQb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgfSk7XG5cblxuICAgIGNvbnN0IHN1Ym1pdFRyYW5zYWN0aW9uTGFtYmRhID0gbmV3IGxhbWJkYU5vZGVqcy5Ob2RlanNGdW5jdGlvbih0aGlzLCBcIlJlY29uU3RhY2tTdWJtaXRUcmFuc2FjdGlvbkxhbWJkYVwiLCB7XG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMThfWCxcbiAgICAgIGVudHJ5OiBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uLy4uL2xhbWJkYXMvc3VibWl0LXRyYW5zYWN0aW9uL2luZGV4LnRzXCIpLCAvLyDwn5GIIHBvaW50IHRvIC50cyBmaWxlXG4gICAgICBoYW5kbGVyOiBcImhhbmRsZXJcIiwgLy8g8J+RiCBuYW1lIG9mIHRoZSBleHBvcnRlZCBmdW5jdGlvbiBpbiBpbmRleC50c1xuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgQ1VTVE9NRVJfTEVER0VSX1RBQkxFOiBjdXN0b21lckxlZGdlci50YWJsZU5hbWUsXG4gICAgICB9LFxuICAgIH0pO1xuXG5cbiAgICAvLyBHcmFudCB3cml0ZSBhY2Nlc3NcbiAgICBjdXN0b21lckxlZGdlci5ncmFudFdyaXRlRGF0YShzdWJtaXRUcmFuc2FjdGlvbkxhbWJkYSk7XG5cbiAgICAvLyDwn5qAIEFQSSBHYXRld2F5XG4gICAgY29uc3QgYXBpID0gbmV3IGFwaWdhdGV3YXkuUmVzdEFwaSh0aGlzLCBcIlJlY29uY2lsaWF0aW9uQXBpXCIsIHtcbiAgICAgIHJlc3RBcGlOYW1lOiBcIlJlY29uY2lsaWF0aW9uIFNlcnZpY2VcIixcbiAgICAgIGRlc2NyaXB0aW9uOiBcIkFQSXMgZm9yIGxlZGdlciByZWNvbmNpbGlhdGlvbiBkZW1vXCIsXG4gICAgfSk7XG5cbiAgICAvLyBQT1NUIC90cmFuc2FjdGlvbiDihpIgU3VibWl0VHJhbnNhY3Rpb24gTGFtYmRhXG4gICAgY29uc3QgdHJhbnNhY3Rpb25SZXNvdXJjZSA9IGFwaS5yb290LmFkZFJlc291cmNlKFwidHJhbnNhY3Rpb25cIik7XG4gICAgdHJhbnNhY3Rpb25SZXNvdXJjZS5hZGRNZXRob2QoXCJQT1NUXCIsIG5ldyBhcGlnYXRld2F5LkxhbWJkYUludGVncmF0aW9uKHN1Ym1pdFRyYW5zYWN0aW9uTGFtYmRhKSk7XG5cblxuICAgIC8vIFByb2Nlc3NvclNpbXVsYXRvciBMYW1iZGFcbiAgICBjb25zdCBwcm9jZXNzb3JTaW11bGF0b3JMYW1iZGEgPSBuZXcgbGFtYmRhTm9kZWpzLk5vZGVqc0Z1bmN0aW9uKFxuICAgICAgdGhpcyxcbiAgICAgIFwiUmVjb25TdGFja1Byb2Nlc3NvclNpbXVsYXRvckxhbWJkYVwiLFxuICAgICAge1xuICAgICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMThfWCxcbiAgICAgICAgZW50cnk6IHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vLi4vbGFtYmRhcy9wcm9jZXNzb3Itc2ltdWxhdG9yL2luZGV4LnRzXCIpLFxuICAgICAgICBoYW5kbGVyOiBcImhhbmRsZXJcIixcbiAgICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgICBQUk9DRVNTT1JfTEVER0VSX1RBQkxFOiBwcm9jZXNzb3JMZWRnZXIudGFibGVOYW1lLFxuICAgICAgICB9LFxuICAgICAgfVxuICAgICk7XG5cbiAgICAvLyBHcmFudCB3cml0ZSBhY2Nlc3NcbiAgICBwcm9jZXNzb3JMZWRnZXIuZ3JhbnRXcml0ZURhdGEocHJvY2Vzc29yU2ltdWxhdG9yTGFtYmRhKTtcblxuICAgIC8vIEFQSSBHYXRld2F5IOKAkyBhZGQgL3NpbXVsYXRlL3Byb2Nlc3NvclxuICAgIGNvbnN0IHNpbXVsYXRlUmVzb3VyY2UgPSBhcGkucm9vdC5hZGRSZXNvdXJjZShcInNpbXVsYXRlXCIpO1xuICAgIGNvbnN0IHByb2Nlc3NvclJlc291cmNlID0gc2ltdWxhdGVSZXNvdXJjZS5hZGRSZXNvdXJjZShcInByb2Nlc3NvclwiKTtcbiAgICBwcm9jZXNzb3JSZXNvdXJjZS5hZGRNZXRob2QoXG4gICAgICBcIlBPU1RcIixcbiAgICAgIG5ldyBhcGlnYXRld2F5LkxhbWJkYUludGVncmF0aW9uKHByb2Nlc3NvclNpbXVsYXRvckxhbWJkYSlcbiAgICApO1xuXG4gICAgLy8gQ29yZVNpbXVsYXRvciBMYW1iZGFcbiAgICBjb25zdCBjb3JlU2ltdWxhdG9yTGFtYmRhID0gbmV3IGxhbWJkYU5vZGVqcy5Ob2RlanNGdW5jdGlvbihcbiAgICAgIHRoaXMsXG4gICAgICBcIlJlY29uU3RhY2tDb3JlU2ltdWxhdG9yTGFtYmRhXCIsXG4gICAgICB7XG4gICAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xOF9YLFxuICAgICAgICBlbnRyeTogcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLi8uLi9sYW1iZGFzL2NvcmUtc2ltdWxhdG9yL2luZGV4LnRzXCIpLFxuICAgICAgICBoYW5kbGVyOiBcImhhbmRsZXJcIixcbiAgICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgICBDT1JFX0xFREdFUl9UQUJMRTogY29yZUxlZGdlci50YWJsZU5hbWUsXG4gICAgICAgIH0sXG4gICAgICB9XG4gICAgKTtcblxuICAgIC8vIEdyYW50IHdyaXRlIGFjY2Vzc1xuICAgIGNvcmVMZWRnZXIuZ3JhbnRXcml0ZURhdGEoY29yZVNpbXVsYXRvckxhbWJkYSk7XG5cbiAgICAvLyBBUEkgR2F0ZXdheSDigJMgYWRkIC9zaW11bGF0ZS9jb3JlXG4gICAgY29uc3QgY29yZVJlc291cmNlID0gc2ltdWxhdGVSZXNvdXJjZS5hZGRSZXNvdXJjZShcImNvcmVcIik7XG4gICAgY29yZVJlc291cmNlLmFkZE1ldGhvZChcIlBPU1RcIiwgbmV3IGFwaWdhdGV3YXkuTGFtYmRhSW50ZWdyYXRpb24oY29yZVNpbXVsYXRvckxhbWJkYSkpO1xuXG4gICAgLy8gUmVjb25jaWxpYXRpb25FbmdpbmUgTGFtYmRhXG4gICAgY29uc3QgcmVjb25jaWxpYXRpb25GbiA9IG5ldyBsYW1iZGFOb2RlanMuTm9kZWpzRnVuY3Rpb24oXG4gICAgICB0aGlzLFxuICAgICAgXCJSZWNvblN0YWNrUmVjb25jaWxpYXRpb25FbmdpbmVMYW1iZGFcIixcbiAgICAgIHtcbiAgICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE4X1gsXG4gICAgICAgIGVudHJ5OiBwYXRoLmpvaW4oXG4gICAgICAgICAgX19kaXJuYW1lLFxuICAgICAgICAgIFwiLi4vLi4vbGFtYmRhcy9yZWNvbmNpbGlhdGlvbi1lbmdpbmUvaW5kZXgudHNcIlxuICAgICAgICApLFxuICAgICAgICBoYW5kbGVyOiBcImhhbmRsZXJcIixcbiAgICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgICBDVVNUT01FUl9MRURHRVJfVEFCTEU6IGN1c3RvbWVyTGVkZ2VyLnRhYmxlTmFtZSxcbiAgICAgICAgICBQUk9DRVNTT1JfTEVER0VSX1RBQkxFOiBwcm9jZXNzb3JMZWRnZXIudGFibGVOYW1lLFxuICAgICAgICAgIENPUkVfTEVER0VSX1RBQkxFOiBjb3JlTGVkZ2VyLnRhYmxlTmFtZSxcbiAgICAgICAgICBGSU5ESU5HU19UQUJMRTogcmVjb25jaWxpYXRpb25GaW5kaW5ncy50YWJsZU5hbWUsXG4gICAgICAgICAgQVVESVRfVEFCTEU6IHJlY29uY2lsaWF0aW9uQXVkaXQudGFibGVOYW1lLFxuICAgICAgICB9LFxuICAgICAgfVxuICAgICk7XG5cbiAgICAvLyBQZXJtaXNzaW9uc1xuICAgIGN1c3RvbWVyTGVkZ2VyLmdyYW50UmVhZFdyaXRlRGF0YShyZWNvbmNpbGlhdGlvbkZuKTtcbiAgICBwcm9jZXNzb3JMZWRnZXIuZ3JhbnRSZWFkRGF0YShyZWNvbmNpbGlhdGlvbkZuKTtcbiAgICBjb3JlTGVkZ2VyLmdyYW50UmVhZERhdGEocmVjb25jaWxpYXRpb25Gbik7XG4gICAgcmVjb25jaWxpYXRpb25GaW5kaW5ncy5ncmFudFJlYWRXcml0ZURhdGEocmVjb25jaWxpYXRpb25Gbik7XG4gICAgcmVjb25jaWxpYXRpb25BdWRpdC5ncmFudFdyaXRlRGF0YShyZWNvbmNpbGlhdGlvbkZuKTtcblxuICAgIC8vIEF0dGFjaCBzdHJlYW1zXG4gICAgcmVjb25jaWxpYXRpb25Gbi5hZGRFdmVudFNvdXJjZShuZXcgc291cmNlcy5EeW5hbW9FdmVudFNvdXJjZShjdXN0b21lckxlZGdlciwgeyBzdGFydGluZ1Bvc2l0aW9uOiBsYW1iZGEuU3RhcnRpbmdQb3NpdGlvbi5MQVRFU1QgfSkpO1xuICAgIHJlY29uY2lsaWF0aW9uRm4uYWRkRXZlbnRTb3VyY2UobmV3IHNvdXJjZXMuRHluYW1vRXZlbnRTb3VyY2UocHJvY2Vzc29yTGVkZ2VyLCB7IHN0YXJ0aW5nUG9zaXRpb246IGxhbWJkYS5TdGFydGluZ1Bvc2l0aW9uLkxBVEVTVCB9KSk7XG4gICAgcmVjb25jaWxpYXRpb25Gbi5hZGRFdmVudFNvdXJjZShuZXcgc291cmNlcy5EeW5hbW9FdmVudFNvdXJjZShjb3JlTGVkZ2VyLCB7IHN0YXJ0aW5nUG9zaXRpb246IGxhbWJkYS5TdGFydGluZ1Bvc2l0aW9uLkxBVEVTVCB9KSk7XG4gIH1cblxuXG59XG4iXX0=